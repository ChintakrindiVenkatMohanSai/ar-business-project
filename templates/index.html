<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Custom AR Viewer</title>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158/examples/js/webxr/ARButton.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158/examples/js/loaders/GLTFLoader.js"></script>

<style>
body{
 margin:0;
 overflow:hidden;
 font-family:Arial;
}
</style>
</head>

<body>

<script>
let camera, scene, renderer, model;
let hitTestSource=null;
let hitTestSourceRequested=false;
let startX=0, rotation=0;

init();
animate();

function init(){

 scene=new THREE.Scene();
 camera=new THREE.PerspectiveCamera();

 renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
 renderer.setSize(window.innerWidth,window.innerHeight);
 renderer.xr.enabled=true;

 document.body.appendChild(renderer.domElement);

 document.body.appendChild(
  ARButton.createButton(renderer,{
   requiredFeatures:['hit-test']
  })
 );

 const light=new THREE.HemisphereLight(0xffffff,0xbbbbff,1);
 scene.add(light);

 // LOAD MODEL
 const loader=new THREE.GLTFLoader();
 loader.load(
  "/uploads/Astronaut (1).glb", // <-- PUT YOUR MODEL NAME HERE
  gltf=>{
   model=gltf.scene;
   model.scale.set(0.5,0.5,0.5);
   model.visible=false;
   scene.add(model);
  }
 );

 // DRAG ROTATION
 renderer.domElement.addEventListener("touchstart",e=>{
  startX=e.touches[0].clientX;
 });

 renderer.domElement.addEventListener("touchmove",e=>{
  if(model && model.visible){
   let dx=e.touches[0].clientX-startX;
   rotation+=dx*0.01;
   model.rotation.y=rotation;
   startX=e.touches[0].clientX;
  }
 });

}

function animate(){
 renderer.setAnimationLoop(render);
}

function render(timestamp,frame){

 if(frame){

  const referenceSpace=renderer.xr.getReferenceSpace();
  const session=renderer.xr.getSession();

  if(!hitTestSourceRequested){

   session.requestReferenceSpace('viewer').then(space=>{
    session.requestHitTestSource({space}).then(source=>{
     hitTestSource=source;
    });
   });

   session.addEventListener('end',()=>{
    hitTestSourceRequested=false;
    hitTestSource=null;
   });

   hitTestSourceRequested=true;
  }

  if(hitTestSource){

   const hitTestResults=frame.getHitTestResults(hitTestSource);

   if(hitTestResults.length>0){

    const hit=hitTestResults[0];
    const pose=hit.getPose(referenceSpace);

    if(model && !model.visible){
     model.visible=true;
     model.position.set(
      pose.transform.position.x,
      pose.transform.position.y,
      pose.transform.position.z
     );
    }

   }

  }

 }

 renderer.render(scene,camera);
}
</script>

</body>
</html>
